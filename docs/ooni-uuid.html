
<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ooni-uuid.md</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.3.0/milligram.min.css">
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@300;400;600&display=swap" rel="stylesheet">
<style>

html, body {
margin: 0;
font-family: "Fira Sans", sans-serif;
font-weight: 400;
}
.header {
padding: 2rem;
background-color: #0588cb;
color: #fff;
margin-bottom: 2rem;
}
a {
color: #0588cb;
}
pre {
border-left: none !important;
padding: 0.5rem 1rem;
}
a.headerlink {
color: #868e96
}
a.headerlink:hover {
color: #0588cb;
}
div#pagepath { padding-bottom: 1em }
h1 { font-size: 48px; font-weight: 300; }
h2 { font-size: 36px; font-weight: 600; }
h3 { font-size: 28px; font-weight: 600; }
h4 { font-size: 22px; font-weight: 600; }
h5 { font-size: 20px; font-weight: 600; }
h6 { font-size: 20px; font-weight: 600; }
h7 { font-size: 20px; font-weight: 600; }
div.toc {
border: 1px solid #ccc;
margin: 1em;
padding: 1em;
border-radius: 10px;
font-size: 115%;
}
footer {
background-color: rgb(0, 54, 91);
padding: 2rem;
color: #fff;
font-size: 14px;
font-family: "Fira Sans", sans-serif;
margin-top: 2rem;
}
.pt-1 {
padding-top: 0.25rem;
}
.pb-2 {
padding-bottom: 0.5rem;
}
.pb-4 {
padding-bottom: 1rem;
}
.footer-section-title {
font-weight: bold;
}
footer a {
color: #fff;
opacity: 0.5;
padding: 2px 0;
margin: 2px 0;
}
footer a:hover {
color: #fff;
opacity: 1;
}
.button {
color: #0588cb !important;
border-color: #0588cb !important;
}
.button:hover,.button:focus {
color: #343a40 !important;
border-color: #343a40 !important;

}
.button-small {
padding: 0 2rem;
height: 3.5rem;
line-height: 3.5rem;
}
</style>
</head>
<body>
<div class="header">
  <div class="row">
    <div class="column">
      <h2>Project documentation</h2>
    </div>
  </div>
</div>
<div class="container">
<div id="pagepath"><a href='../index.html'></a> » <a href='/index.html'>docs</a> » <a href=''>ooni-uuid.md</a></div><h3 id="on-ooid-ooni-measurement-uuid">On <code>OOID</code> OONI measurement UUID<a class="headerlink" href="#on-ooid-ooni-measurement-uuid" title="Permanent link"> #</a></h3>
<p>Every measurement already has some set of identifiers described in <a href="https://github.com/ooni/spec/blob/master/data-formats/df-000-base.md">OONI Spec</a>:</p>
<ul>
<li><code>id</code> — UUID stamped by client, fallback to <code>UUID(bytes=(sha1(measurement_blob)[:16]))</code> at pipeline</li>
<li><code>report_id</code> — generated by collector on opening <code>/report</code> as <code>{server_now|iso8601}_AS{asn}_{urandom_alnum(50)}</code>, stamped by client. Old yaml reports have it <a href="https://github.com/TheTorProject/ooni-pipeline/blob/4ddc40b6ab5eafc5759eeaf4f23dcf05bdbf6e65/af/shovel/autoclaving.py#L225-L235">generated by pipeline</a> as <code>{start_time}_{hash_cc_asn_test_ver_city_alnum(50)}</code> that has <em>at most</em> 34 bits entropy for 50-byte string. Some json reports have <code>null</code> values, some yaml reports have <code>urandom_alnum(64)</code>. Collector and pipeline do not enforce report body and filename to contain same <code>report_id</code>!</li>
<li><code>bucket_date</code> — stamped by pipeline while processing daily bucket</li>
<li><code>${report_filename}</code> — generated by collector on <code>/report/{report_id}/close</code> as <code>{start_time or test_start_time|iso8601}-{test_name}-{report_id}-AS{asn}-{probe_cc}-….{ext}</code>. That enforces <code>report_id</code> being stored as part of <code>${report_filename}</code>. Both <code>start_time</code> and <code>test_start_time</code> come from client as part of opening <code>/report</code></li>
<li><code>report_filename</code> — generated by pipeline as <code>{bucket_date}/${report_filename}</code> preserving extension of original report file</li>
<li><code>test_start_time</code> — <a href="https://github.com/TheTorProject/ooni-pipeline/blob/4ddc40b6ab5eafc5759eeaf4f23dcf05bdbf6e65/af/shovel/daily_workflow.py#L475-L493">pipeline-messed</a> mix of <code>test_start_time</code> and <code>start_time</code> from raw file</li>
<li><code>measurement_start_time</code> — pipeline-messed mix of <code>measurement_start_time</code>, <code>test_start_time</code> and <code>start_time</code> from raw file</li>
<li><code>test_started</code> — float(time_t) present in 19519 measurements as seen by <code>select count(*) from measurement join residual using (residual_no) where residual-&gt;'test_keys' ? 'test_started'</code></li>
<li><code>input</code> — stamped by client, was part of OONI Explorer URL scheme together with <code>report_id</code></li>
</ul>
<p>All these identifiers are not nice due to following reasons:</p>
<ul>
<li>most of them are generated by client, <code>report_id</code> may be server-generated, but it's not enforced by the pipeline</li>
<li>ones having timestamp use client-side timestamp that is not protected from <em>"time travellers"</em></li>
<li>most of them have low entropy-per-byte ratio</li>
<li><code>test_start_time</code> and <code>measurement_start_time</code> are overriden in pipeline and are different in <em>canned</em> and <em>autoclaved</em> data, <code>test_started</code> is not even respected (e.g. it's not promoted to <code>measurement_start_time</code> in <a href="https://api.ooni.io/files/download/2012-12-30/20121230T142923Z-RU-AS57668-http_requests-no_report_id-0.1.0-probe.yaml">this file</a> that has <code>measurement_start_time</code> and <code>test_start_time</code> equal for all measurements)</li>
</ul>
<p>It's nice to have int64 identifier having 32 bits allocated for <code>time_t</code> as an unique identifier of every measurement collected. It has to respect following constraints and corner-cases:</p>
<ul>
<li>max number of measurements per report file is 1000003 (20 bits) for 2014-11-22/20141122T040940Z-US-AS1968-tcp_connect-no_report_id-0.1.0-probe.yaml (top5 is 1000003, 65007, 41889, 40875, 30949)</li>
<li>max number of measurements per report file in 2018-01-01 … 2018-06-15 time window is ~5000</li>
<li>client may have wrong wall-clock date, e.g. <a href="https://api.ooni.io/files/download/2018-06-03/20180802T130309Z-LY-AS37284-ndt-20180602T130508Z_AS37284_Vl7cO6V33OkYBoJgQL403dM2L4arYk7WEAeiPizIW6au6aVfV5-0.2.0-probe.json">2018-06-02 13:05:08</a> reports <code>test_start_time</code> fro2018-08-02 13:03:09 from future and <a href="https://api.ooni.io/files/download/2017-11-14/20031106T094115Z-IQ-AS50710-ndt-20171113T151305Z_AS50710_beuliHbl2zzV3F05or7NIt4ynhZFUCCOjKf1okz1zTov3lvLJU-0.2.0-probe.json">2017-11-13 15:13:05</a> reports from past 2003-11-06 09:41:15.</li>
<li>client may write wrong timezone in <code>test_start_time</code> and <code>measurement_start_time</code>, see <a href="https://api.ooni.io/files/download/2018-06-07/20180606T015613Z-SG-AS7472-http_requests-g14IPb8Zf91k1IUMhj9GfMDoXcOXnjywlCuaxEv0WdHHgRbA6ORUEiezcooJUddc-0.1.0-probe.yaml">2018-06-06 01:56:13</a> having <code>test_start_time</code> 2018-06-06 08:56:05 and <code>measurement_start_time</code> 2018-06-06 08:56:13 for the first measurement. Correctness of filename-based guess relies on on <code>Date</code> HTTP headers in server responses saying 06 Jun 2018 01:56:14 GMT</li>
<li>report_id may have no timestamp. E.g. <a href="https://api.ooni.io/files/download/2018-06-19/20180618T043905Z-RU-AS58191-http_header_field_manipulation-bMr4ueruR8QGX1fjw3dBIOHekiQ2Yxv3prXOO8zw4Qu0NEb0XYU9Em9LyyVaBK3b-0.1.0-probe.yaml">bMr4ueruR8QGX1fjw3dBIOHekiQ2Yxv3prXOO8zw4Qu0NEb0XYU9Em9LyyVaBK3b</a> has following <em>raw</em> fields: <code>start_time</code>: 1529285941.0 (01:39:01 UTC) , <code>test_start_time</code>: 2018-06-18 04:39:05, and <code>measurement/test_start_time</code>: 1529285945.0 (01:39:05 UTC). Processed <em>autoclaved</em> file has <code>test_start_time</code>: 2018-06-18 01:39:01 and <code>measurement_start_time</code>: 2018-06-18 01:39:05. So It suggests that 01:39 is right UTC timestamp. But it's wrong assumption, there is a report coming from <em>alike</em> probe (same version, same AS, close time), <a href="https://api.ooni.io/files/download/2018-06-19/20180618T043906Z-RU-AS58191-http_requests-WqMmGyBUMXRxSDGde6Wb8lZMR5vlls0rInMeAo3ro4K6nlSjVwrrBa90fIpNmLzQ-0.1.0-probe.yaml">it shows that</a> that also has <code>test_start_time</code>: 01:39:01, <code>measurement_start_time</code>: 01:46:40, but HTTP <code>Date</code> headers explicitly say <code>Mon, 18 Jun 2018 04:46:35 GMT</code>. So it means that client-generated-server-serialised timestamp still preserves date and time better than fields within message body. <strong>NB</strong>: UNIX timestamp in raw file is incorrect in this example, it's adjusted for timezone offset!</li>
<li>generated report_id may still have correct timestamp as well for some yaml files, e.g. <a href="https://api.ooni.io/files/download/2012-12-30/20121230T142923Z-RU-AS57668-http_requests-no_report_id-0.1.0-probe.yaml">2012-12-30 14:29:23</a></li>
<li>report_id may be missing, e.g. <a href="https://api.ooni.io/files/download/2016-08-01/20160731T103922Z-US-AS14618-dns_injection-no_report_id-0.2.0-probe.json">2016-07-31 10:39:22</a> has generated <code>report_id</code> EGTL4PNEIF5K3yNuLA55_gb935U as base64(sha1(raw_file)) in database, but it's not stamped in filename or autoclaved file</li>
<li>report_id may be duplicate and indicate several retries to submit report, e.g. <code>2018-05-06/20180505T000008Z-NL-AS9143-web_connectivity-20180505T000008Z_AS9143_YXblHbyqIlBUxqzkwQ344hJM4O19Nx9q2E90RUv4W6yFTi4QyS-0.2.0-probe.json</code> and <code>2018-05-10/20180505T000008Z-NL-AS9143-web_connectivity-20180505T000008Z_AS9143_YXblHbyqIlBUxqzkwQ344hJM4O19Nx9q2E90RUv4W6yFTi4QyS-0.2.0-probe.json</code></li>
<li>report_id may be duplicate across <em>different(!)</em> report files, e.g. <code>2016-02-11/20160210T163242Z-IR-AS201227-http_requests-yZthLDkKNe6IdePf7B1gMgNvRxSMDwNGWD6BB1MWcuY2T3q7oLmDQkjhZARARuic-0.1.0-probe.yaml</code> and <code>2016-02-23/20160210T163242Z-IR-AS201227-http_requests-yZthLDkKNe6IdePf7B1gMgNvRxSMDwNGWD6BB1MWcuY2T3q7oLmDQkjhZARARuic-0.1.0-probe.yaml</code></li>
<li><code>bucket_date</code> can be more than a year away from HTTP <code>Date</code> timestamps while <code>report_id</code> timestamp is reasonable, e.g. <a href="https://api.ooni.io/files/download/2016-02-27/20150201T095956Z-BE-AS12392-http_requests-no_report_id-0.1.0-probe.yaml">2015-02-01</a>, that's likely upload of ancient measurements</li>
<li>the dataset has 3.6M reports. 80% have unique timestamps, but 753k reports have 316k coincident timestamps, having at most ~20 reports per timestamp</li>
<li>the dataset has 147M measurements, at least 28 bits are needed to numerate them</li>
</ul>
<p>Moreover we would like the OONI UUID to have the following properties:</p>
<ul>
<li>It's a 64 bit integer (8 bytes) so that it can fits into postgres <code>bigint</code> fixed-width native type unlike larger fields</li>
<li>A sort of "namespace" separation to distinguish pipeline-backfilled OOIDs from collector-stamped OOIDs during rollout of stamping collector</li>
<li>There is some loose ordering over the ID so that measurements that are close in time have an ID that is of similar cardinality (ex. all measurements from 2018 should have an ID that is <code>&lt;&lt;</code> measurements from 2019).</li>
</ul>
<p>And that's probably incomplete list of corner cases.</p>
<h4 id="backfilled-ooid">Backfilled OOID<a class="headerlink" href="#backfilled-ooid" title="Permanent link"> #</a></h4>
<p>So, given that:</p>
<ul>
<li>Timestamps in the measurement body (i.e. <code>test_start_time</code>, <code>measurement_start_time</code>, etc.) are unreliable</li>
<li>We have bucket date and filename as a part of "golden" dataset</li>
<li>We have quite precise timestamp as part of dataset</li>
</ul>
<p>The proposed schema for <em>backfilled</em> <code>OOID</code> (OONI UUID) is the following:</p>
<ul>
<li>32 bits representing time_t stored as <code>report_id</code> part of textname, fallback to time_t stored as prefix of the textname basename that usually represents server-side interpretation of client-side <code>test_start_time</code> (i.e. we try to get from the data we have available the time that is closest to when the measurement was submitted to the collector, approximating, in the worst case, to the time in which the measurement was added to a bucket). </li>
<li>4 bits set to <code>1</code> forming nibble <code>f</code> (which is a reserved magic value to indicate the <code>ooid</code> was backfilled)</li>
<li>28 bits of counter indicating measurement index within report file initialised with 28 least significant bits of <code>sha1(b'2014-11-18/2014…-probe.yaml')</code></li>
</ul>
<p>Note: we tested with historical data up to 2018-06-20, that using the 28 least significant bits of the output of <code>sha1</code> does not lead to a collision, but we may change this offset if we notice a collision while we roll-out this feature. See the below sections for more details on this.</p>
<p>Amount of static bits may be reduced to single <code>1</code> bit, but 28 bits of entropy are enough to avoid collisions and single <code>f</code> nibble looks nice in logs.</p>
<h5 id="textname-to-time_t-test-vectors"><code>textname</code> to <code>time_t</code> test vectors<a class="headerlink" href="#textname-to-time_t-test-vectors" title="Permanent link"> #</a></h5>
<p>Here is the Python code implementing suggested textname to time_t transformation:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">calendar</span>
<span class="n">rex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="sa">r</span><span class="s1">&#39;^(?P&lt;bktyear&gt;20[0-9]</span><span class="si">{2}</span><span class="s1">)-(?P&lt;bktmon&gt;[01][0-9])-(?P&lt;bktday&gt;[0123][0-9])/&#39;</span>
    <span class="sa">r</span><span class="s1">&#39;(?P&lt;year&gt;20[0-9]</span><span class="si">{2}</span><span class="s1">)(?P&lt;mon&gt;[01][0-9])(?P&lt;day&gt;[0123][0-9])T(?P&lt;hr&gt;[012][0-9])(?P&lt;min&gt;[0-5][0-9])(?P&lt;sec&gt;[0-5][0-9])Z-&#39;</span>
    <span class="sa">r</span><span class="s1">&#39;[A-Z][A-Z]-&#39;</span> <span class="c1"># can be replaced with list of ISO country codes</span>
    <span class="sa">r</span><span class="s1">&#39;AS(?P&lt;asn&gt;[0-9]{1,10})-&#39;</span> <span class="c1"># ASN is 32bit at most</span>
    <span class="sa">r</span><span class="s1">&#39;[^-]+-&#39;</span> <span class="c1"># test name</span>
    <span class="sa">r</span><span class="s1">&#39;(?P&lt;report_id&gt;no_report_id&#39;</span>
        <span class="sa">r</span><span class="s1">&#39;|(?P&lt;ridyear&gt;20[0-9]</span><span class="si">{2}</span><span class="s1">)(?P&lt;ridmon&gt;[01][0-9])(?P&lt;ridday&gt;[0123][0-9])T(?P&lt;ridhr&gt;[012][0-9])(?P&lt;ridmin&gt;[0-5][0-9])(?P&lt;ridsec&gt;[0-5][0-9])Z_AS(?P=asn)_[0-9A-Za-z]</span><span class="si">{50}</span><span class="s1">&#39;</span>
        <span class="sa">r</span><span class="s1">&#39;|[A-Za-z0-9]</span><span class="si">{64}</span><span class="s1">&#39;</span>
    <span class="sa">r</span><span class="s1">&#39;)-&#39;</span>
    <span class="sa">r</span><span class="s1">&#39;0\.[12]\.0-probe\.(?:yaml|json)$&#39;</span><span class="p">)</span> <span class="c1"># trailer</span>
<span class="k">def</span> <span class="nf">ts</span><span class="p">(</span><span class="n">textname</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">rex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">textname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;ridyear&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;ridyear&#39;</span><span class="p">,</span> <span class="s1">&#39;ridmon&#39;</span><span class="p">,</span> <span class="s1">&#39;ridday&#39;</span><span class="p">,</span> <span class="s1">&#39;ridhr&#39;</span><span class="p">,</span> <span class="s1">&#39;ridmin&#39;</span><span class="p">,</span> <span class="s1">&#39;ridsec&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;mon&#39;</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="s1">&#39;hr&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;sec&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">calendar</span><span class="o">.</span><span class="n">timegm</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">_</span><span class="p">))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">))</span>
</code></pre></div>

<p>Test vectors:</p>
<div class="codehilite"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="n">ts</span><span class="p">(</span><span class="s1">&#39;2016-02-11/20160210T163242Z-IR-AS201227-http_requests-yZthLDkKNe6IdePf7B1gMgNvRxSMDwNGWD6BB1MWcuY2T3q7oLmDQkjhZARARuic-0.1.0-probe.yaml&#39;</span><span class="p">)</span><span class="w"></span>
<span class="mi">1455121962</span><span class="w"> </span><span class="c1"># 2016-02-10 16:32:42 UTC, bucket date is ignored</span><span class="w"></span>
<span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="n">ts</span><span class="p">(</span><span class="s1">&#39;2017-11-14/20031106T094115Z-IQ-AS50710-ndt-20171113T151305Z_AS50710_beuliHbl2zzV3F05or7NIt4ynhZFUCCOjKf1okz1zTov3lvLJU-0.2.0-probe.json&#39;</span><span class="p">)</span><span class="w"></span>
<span class="mi">1510585985</span><span class="w"> </span><span class="c1"># 2017-11-13 15:13:05 UTC, time from `report_id` is used</span><span class="w"></span>
</code></pre></div>

<h5 id="hash-for-32428-scheme">Hash for 32:4:28 scheme<a class="headerlink" href="#hash-for-32428-scheme" title="Permanent link"> #</a></h5>
<p>Table describes sha1.hexdigest() offsets producing collision-free OOIDs for all the collected reports up to 2018-06-20 bucket:</p>
<p>counter bits | 7-digit nibble-aligned offset within sha1
-------------|---------------------------------------------
28 | 4 5 6 7 9 11 12 14 16 17 18 19 20 23 26 28 30 31 32 33
27 | 4 5 6   9 11 12 14 16       19 20 23    28 30 31 32 33
26 | 4 5          12 14          19 20 23       30 31 32 33
25 |                             19                      33
24 | not enough entropy within any offset of sha1(textname).hexdigest()</p>
<p>The smallest known timestamp in the current dataset is 0x50bef44d (2012-12-05 07:14:21 UTC), so OOID with first nibble [0-4] may have different binary meaning.
The largest one is 0x5b29a005 (2018-06-20 00:29:57), but that's subject to change :-)</p>
<p>Here is the Python code implementing suggested OOID:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">hashlib</span>
<span class="k">def</span> <span class="nf">ooid3</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">textname</span><span class="p">,</span> <span class="n">ndx</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">textname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;20&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">textname</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="sa">b</span><span class="s1">&#39;.yaml&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;.json&#39;</span><span class="p">))</span> <span class="ow">and</span> <span class="n">ndx</span> <span class="o">&gt;=</span> <span class="mi">0</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span>
    <span class="n">colid</span> <span class="o">=</span> <span class="mh">0xf0000000</span>
    <span class="n">cnt</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">textname</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[</span><span class="o">-</span><span class="mi">7</span><span class="p">:],</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="n">ndx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0fffffff</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">ts</span> <span class="o">&amp;</span> <span class="n">colid</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">ts</span> <span class="o">&amp;</span> <span class="n">cnt</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">colid</span> <span class="o">&amp;</span> <span class="n">cnt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="nb">hex</span><span class="p">(</span><span class="n">ts</span> <span class="o">|</span> <span class="n">colid</span> <span class="o">|</span> <span class="n">cnt</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span>
<span class="k">def</span> <span class="nf">ooid</span><span class="p">(</span><span class="n">textname</span><span class="p">,</span> <span class="n">ndx</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ooid3</span><span class="p">(</span><span class="n">ts</span><span class="p">(</span><span class="n">textname</span><span class="p">),</span> <span class="n">textname</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">),</span> <span class="n">ndx</span><span class="p">)</span>
</code></pre></div>

<p>Test vectors:</p>
<div class="codehilite"><pre><span></span><code>&gt;&gt;&gt; ooid(&#39;2012-12-05/20121205T071421Z-MM-AS18399-http_invalid_request_line-no_report_id-0.1.0-probe.yaml&#39;, 0)
&#39;50bef44df29c69e2&#39;
&gt;&gt;&gt; ooid(&#39;2012-12-05/20121205T071421Z-MM-AS18399-http_invalid_request_line-no_report_id-0.1.0-probe.yaml&#39;, 1)
&#39;50bef44df29c69e3&#39;
&gt;&gt;&gt; ooid(&#39;2018-06-20/20180620T002915Z-DE-AS28753-http_header_field_manipulation-20180620T002917Z_AS28753_ZryhjoYMtU6jEx9TOjDCRuBo5z5te2fLWWj7gkvmkMkbLlnFTi-0.2.0-probe.json&#39;, 0)
&#39;5b299fddf5c34544&#39;
</code></pre></div>

<h5 id="using-less-bits-for-counter">Using less bits for counter<a class="headerlink" href="#using-less-bits-for-counter" title="Permanent link"> #</a></h5>
<p>If the OOID prefix is the same for all the measurements in the report file, then the minimal possible bit length for the counter is 20 bits. There is a report having 1000003 measurements that needs at least 20 bits.</p>
<p>It's not trivial to have numbering schema that depends only on report file and does not provide collisions across different reports. The outline of collision probability for $time:$static:$counter schema over the whole dataset is estimated below.</p>
<p>It's practical to brute-force a sha1-hmac or siphash key to make counter 24 bit, so it'll be aligned at byte boundary.
The probability of collision of single hash function truncated to 24 bits among those 316k coincident timestamps is ~3e-4, so it's like brute-forcing ~11 bits.</p>
<p>It's not practical to make counter 20 bit with <em>single</em> hash function as it's
equivalent to brute-forcing 186-bit key. But it's practical to have ~128...256
<em>independent</em> keys for hash function to have collision-free 20 bit counter for backfilling.</p>
<p>Estimates of those probabilities are available in <a href="./ooid-hash-prob.ipynb">jupyter notebook</a>.</p>
<h4 id="collector-stamped-ooid">Collector-stamped OOID<a class="headerlink" href="#collector-stamped-ooid" title="Permanent link"> #</a></h4>
<p>Collector should use following schema to stamp OOID on every measurement within report file while closing report:</p>
<ul>
<li>32 bits to represent time when the measurement is <em>received</em> according to collector's wall clock</li>
<li>8 bits in {0...0xEF} range representing Collector-ID</li>
<li>24 bits of counter</li>
</ul>
<p>int24 counter is enough to stamp 16M measurements per second. Smallest possible
measurement with probe_asn, probe_cc, test_runtime and alike fields is at least
286 bytes.  That makes at least ~38Gbit/s stream.  That's way higher than
throughput of LZ4 decompressor we've seen (11Gbit/s) and/or available wire
speeds (10Gbit/s).</p>
<p><code>Collector-ID</code> is a value stored in configuration file representing unique
collector OS process running somewhere. That limits overall number of
concurrently running collectors with ~240 instances. That's enough for now and
foreseeable future.</p>
<p>Report may be submitted through different collector instances. Collector-ID and
timestamp of the collector receiving the message should be used.</p>
<p>Collector should ensure both during run-time and start-time, that...
- wall clock for specific Collector-ID does not tick backwards
- counter does not overflow within specific second</p>
<h4 id="ooid-representation">OOID representation<a class="headerlink" href="#ooid-representation" title="Permanent link"> #</a></h4>
<p>Canonical representation of OOID should be hex string.
It's nice to be able to strip first 8 characters and feed them into <code>date -d
@$(( 0x5b2ce5f4 ))</code>.
Int64 may be transparently converted to float64 by javascript / some json
libraries leading to annoying errors.</p></div>
<footer class="p-4">
<div class="container">
<div class="row">
<div class="column column-50">
<div class="pb-2"><img src="https://ooni.org/images/OONI-HorizontalMonochromeInverted.svg" height="32px" /></div>
<div class="pb-4">Global community measuring internet censorship around the world.</div>
<div>
<div>© 2020 Open Observatory of Network Interference (OONI)</div>
<div><a href="https://github.com/ooni/license">Content available under a Creative Commons license.</a></div>
</div>
</div>
<div class="column column-50">
<div class="row">
<div class="column column-30">
<div class="footer-section-title">About</div>
<div class="pt-1"><a href="/about/">OONI</a></div>
<div class="pt-1"><a href="/about/data-policy/">Data Policy</a></div>
<div class="pt-1"><a href="https://github.com/ooni/license/tree/master/data">Data License</a></div>
<div class="pt-1"><a href="/about/#contact">Contact</a></div>
</div>
<div class="column column-30">
<div class="footer-section-title">OONI Probe</div>
<div class="pt-1"><a href="https://ooni.org/install/">Install</a></div>
<div class="pt-1"><a href="https://ooni.org/nettest/">Tests</a></div>
<div class="pt-1"><a href="https://github.com/ooni">Source code</a></div>
<div class="pt-1">
<a href="https://api.ooni.io/">API</a>
</div>
</div>
<div class="column column-30">
<div class="footer-section-title">Updates</div>
<div class="pt-1">
<a href="/post/">Blog</a>
</div>
<div class="pt-1"><a href="https://lists.torproject.org/cgi-bin/mailman/listinfo/ooni-talk">Mailing list</a></div>
<div class="pt-1"><a href="https://slack.ooni.org/">Slack</a></div>
<ul class="pt-1 footer-links-social"></ul>
</div>
</div>
</div>
</div>
</div>
</footer></body></html>